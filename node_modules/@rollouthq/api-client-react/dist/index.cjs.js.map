{"version":3,"sources":["../src/index.ts","../src/trpc.tsx"],"sourcesContent":["export * from \"./trpc\";\nexport type { UseQueryResult } from \"react-query\";\n","import assert from \"assert\";\n\nimport { TRPCClient as GenericTRPCClient, TRPCClientError } from \"@trpc/client\";\nimport { createReactQueryHooks } from \"@trpc/react\";\nimport React, {\n  ReactElement,\n  useRef,\n  useState,\n  createContext,\n  useContext,\n  useMemo,\n  useCallback,\n} from \"react\";\nimport {\n  useQuery as useReactQuery,\n  QueryClient,\n  QueryClientProvider,\n  UseQueryResult,\n} from \"react-query\";\n\nimport {\n  InferQueryInput,\n  InferQueryOutput,\n  TQuery,\n  TRPCRouter,\n} from \"@rollouthq/api\";\n\nexport type {\n  TRPCRouter,\n  TQuery,\n  TMutation,\n  InferMutationInput,\n  InferMutationOutput,\n  InferQueryInput,\n  InferQueryOutput,\n} from \"@rollouthq/api\";\n\nconst trpc = createReactQueryHooks<TRPCRouter>();\n\nexport const useQuery = trpc.useQuery;\nexport const useMutation = trpc.useMutation;\nexport const useTRPCContext = trpc.useContext;\n\n/**\n * Similar to `trpc.useQuery`, but the fetch is initiated imperatively,\n * with `fetch` function.\n * @example const q = useLazyQuery(\"hello\")\n * // somewhere in effect\n * q.fetch({ name: \"world\" })\n */\nexport function useLazyQuery<\n  TQ extends string & TQuery,\n  TI extends InferQueryInput<TQ>\n>(queryPath: TQ) {\n  const { client } = trpc.useContext();\n  const [input, setInput] = useState<TI>();\n  const [enabled, setEnabled] = useState(false);\n\n  const query = useReactQuery(\n    [queryPath, input],\n    () => {\n      assert(input != null);\n      // @ts-expect-error\n      return client.query(queryPath, input);\n    },\n    { enabled }\n  );\n\n  const fetch = (newInput: TI) => {\n    setInput(newInput);\n    setEnabled(true);\n  };\n\n  return {\n    ...query,\n    fetch,\n    input,\n  } as UseLazyQueryResult<TQ>;\n}\n\nexport type UseLazyQueryResult<TQ extends string & TQuery> = UseQueryResult<\n  InferQueryOutput<TQ>\n> & {\n  input: InferQueryInput<TQ>;\n  fetch: (input: InferQueryInput<TQ>) => void;\n};\n\nexport type TRPCClient = GenericTRPCClient<TRPCRouter>;\n\nexport type RolloutAPIClientProviderProps = {\n  token: string | (() => Promise<string> | string);\n  apiBaseUrl: string;\n  children: ReactElement;\n};\n\nexport function RolloutAPIClientProvider(props: RolloutAPIClientProviderProps) {\n  const { token: tokenOrGetToken, apiBaseUrl, children } = props;\n  const tokenRef = useRef<string | undefined>(undefined);\n\n  const getCurrentToken = useCallback(async () => {\n    if (typeof tokenOrGetToken === \"string\") {\n      return tokenOrGetToken;\n    } else {\n      if (tokenRef.current == null) {\n        tokenRef.current = await tokenOrGetToken();\n      }\n      return tokenRef.current;\n    }\n  }, [tokenOrGetToken]);\n\n  const [queryClient] = useState(\n    () =>\n      new QueryClient({\n        defaultOptions: {\n          queries: {\n            refetchOnWindowFocus: false,\n            retry(failureCount, error) {\n              if (error instanceof TRPCClientError) {\n                if (error.data.code === \"NOT_FOUND\") {\n                  return false;\n                }\n                if (error.data.code === \"UNAUTHORIZED\") {\n                  // Reset tokenRef so token is refetched on next request\n                  tokenRef.current = undefined;\n                  return true;\n                }\n              }\n              return true;\n            },\n          },\n        },\n      })\n  );\n\n  const [trpcClient] = useState(() =>\n    trpc.createClient({\n      url: `${apiBaseUrl}/trpc`,\n      async headers() {\n        const token = await getCurrentToken();\n        return {\n          authorization: `Bearer ${token}`,\n        };\n      },\n    })\n  );\n\n  const ctx = useMemo(\n    () => ({\n      getToken: getCurrentToken,\n      apiBaseUrl,\n    }),\n    [apiBaseUrl]\n  );\n\n  return (\n    <RolloutAPIClientContext.Provider value={ctx}>\n      <trpc.Provider client={trpcClient} queryClient={queryClient}>\n        <QueryClientProvider client={queryClient}>\n          {children}\n        </QueryClientProvider>\n      </trpc.Provider>\n    </RolloutAPIClientContext.Provider>\n  );\n}\n\ntype RolloutAPIClientContext = {\n  getToken: () => Promise<string>;\n  apiBaseUrl: string;\n};\n\nconst RolloutAPIClientContext = createContext<\n  RolloutAPIClientContext | undefined\n>(undefined);\n\nexport function useRolloutAPIClientContext() {\n  const context = useContext(RolloutAPIClientContext);\n\n  if (!context) {\n    const error = new Error(\"No RolloutAPIClientContext provided\");\n    error.name = \"ContextError\";\n    Error.captureStackTrace?.(error, useRolloutAPIClientContext);\n    throw error;\n  }\n\n  return context;\n}\n"],"mappings":"0jBAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,8BAAAE,EAAA,iBAAAC,EAAA,gBAAAC,EAAA,aAAAC,EAAA,+BAAAC,EAAA,mBAAAC,IAAA,eAAAC,EAAAR,GCAA,IAAAS,EAAmB,qBAEnBC,EAAiE,wBACjEC,EAAsC,uBACtCA,EAQO,oBACPC,EAKO,uBAmBDC,KAAO,yBAAkC,EAElCC,EAAWD,EAAK,SAChBE,EAAcF,EAAK,YACnBG,EAAiBH,EAAK,WAS5B,SAASI,EAGdC,EAAe,CACf,GAAM,CAAE,OAAAC,CAAO,EAAIN,EAAK,WAAW,EAC7B,CAACO,EAAOC,CAAQ,KAAI,YAAa,EACjC,CAACC,EAASC,CAAU,KAAI,YAAS,EAAK,EAiB5C,MAAO,CACL,MAhBY,EAAAC,UACZ,CAACN,EAAWE,CAAK,EACjB,QACE,EAAAK,SAAOL,GAAS,IAAI,EAEbD,EAAO,MAAMD,EAAWE,CAAK,GAEtC,CAAE,QAAAE,CAAQ,CACZ,EASE,MAPaI,GAAiB,CAC9BL,EAASK,CAAQ,EACjBH,EAAW,EAAI,CACjB,EAKE,MAAAH,CACF,CACF,CAiBO,SAASO,EAAyBC,EAAsC,CAC7E,GAAM,CAAE,MAAOC,EAAiB,WAAAC,EAAY,SAAAC,CAAS,EAAIH,EACnDI,KAAW,UAA2B,MAAS,EAE/CC,KAAkB,eAAY,SAC9B,OAAOJ,GAAoB,SACtBA,GAEHG,EAAS,SAAW,OACtBA,EAAS,QAAU,MAAMH,EAAgB,GAEpCG,EAAS,SAEjB,CAACH,CAAe,CAAC,EAEd,CAACK,CAAW,KAAI,YACpB,IACE,IAAI,cAAY,CACd,eAAgB,CACd,QAAS,CACP,qBAAsB,GACtB,MAAMC,EAAcC,EAAO,CACzB,GAAIA,aAAiB,kBAAiB,CACpC,GAAIA,EAAM,KAAK,OAAS,YACtB,MAAO,GAET,GAAIA,EAAM,KAAK,OAAS,eAEtB,OAAAJ,EAAS,QAAU,OACZ,EAEX,CACA,MAAO,EACT,CACF,CACF,CACF,CAAC,CACL,EAEM,CAACK,CAAU,KAAI,YAAS,IAC5BxB,EAAK,aAAa,CAChB,IAAK,GAAGiB,SACR,MAAM,SAAU,CAEd,MAAO,CACL,cAAe,UAFH,MAAMG,EAAgB,GAGpC,CACF,CACF,CAAC,CACH,EAEMK,KAAM,WACV,KAAO,CACL,SAAUL,EACV,WAAAH,CACF,GACA,CAACA,CAAU,CACb,EAEA,OACE,EAAAS,QAAA,cAACC,EAAwB,SAAxB,CAAiC,MAAOF,GACvC,EAAAC,QAAA,cAAC1B,EAAK,SAAL,CAAc,OAAQwB,EAAY,YAAaH,GAC9C,EAAAK,QAAA,cAAC,uBAAoB,OAAQL,GAC1BH,CACH,CACF,CACF,CAEJ,CAOA,IAAMS,KAA0B,iBAE9B,MAAS,EAEJ,SAASC,GAA6B,CA9K7C,IAAAC,EA+KE,IAAMC,KAAU,cAAWH,CAAuB,EAElD,GAAI,CAACG,EAAS,CACZ,IAAMP,EAAQ,IAAI,MAAM,qCAAqC,EAC7D,MAAAA,EAAM,KAAO,gBACbM,EAAA,MAAM,oBAAN,MAAAA,EAAA,WAA0BN,EAAOK,GAC3BL,CACR,CAEA,OAAOO,CACT","names":["src_exports","__export","RolloutAPIClientProvider","useLazyQuery","useMutation","useQuery","useRolloutAPIClientContext","useTRPCContext","__toCommonJS","import_assert","import_client","import_react","import_react_query","trpc","useQuery","useMutation","useTRPCContext","useLazyQuery","queryPath","client","input","setInput","enabled","setEnabled","useReactQuery","assert","newInput","RolloutAPIClientProvider","props","tokenOrGetToken","apiBaseUrl","children","tokenRef","getCurrentToken","queryClient","failureCount","error","trpcClient","ctx","React","RolloutAPIClientContext","useRolloutAPIClientContext","_a","context"]}